---
# Platform Applications
# Manages all platform infrastructure components
# Uses individual Applications for explicit control over Helm vs Kustomize

# ============================================================================
# Namespaces (sync wave -1 - created before all other resources)
# ============================================================================
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: platform-namespaces
  namespace: rex5-cc-mz-k8s-argocd
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: platform
  source:
    repoURL: git@github.com:kevrex5/kubernetes.git
    targetRevision: HEAD
    path: platform-mz/namespaces
  destination:
    server: https://kubernetes.default.svc
    namespace: default
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=false
      - ServerSideApply=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m

---
# # ============================================================================
# # cert-manager (sync wave 1 - needed for certificates) - DISABLED
# # ============================================================================
# apiVersion: argoproj.io/v1alpha1
# kind: Application
# metadata:
#   name: platform-cert-manager
#   namespace: rex5-cc-mz-k8s-argocd
#   annotations:
#     argocd.argoproj.io/sync-wave: "1"
#   finalizers:
#     - resources-finalizer.argocd.argoproj.io
# spec:
#   project: platform
#   sources:
#     # Helm chart
#     - repoURL: https://charts.jetstack.io
#       chart: cert-manager
#       targetRevision: v1.17.1  # Pinned version
#       helm:
#         valueFiles:
#           - $values/platform/cert-manager/values.yaml
#     # Values and additional resources from Git
#     - repoURL: git@github.com:kevrex5/kubernetes.git
#       targetRevision: HEAD
#       ref: values
#     # ClusterIssuers and other resources
#     - repoURL: git@github.com:kevrex5/kubernetes.git
#       targetRevision: HEAD
#       path: platform/cert-manager
#       directory:
#         exclude: '{values.yaml,kustomization.yaml}'
#   destination:
#     server: https://kubernetes.default.svc
#     namespace: rex5-cc-mz-k8s-cert-manager
#   syncPolicy:
#     automated:
#       prune: true
#       selfHeal: true
#     syncOptions:
#       - CreateNamespace=false
#       - ServerSideApply=true
#     retry:
#       limit: 5
#       backoff:
#         duration: 5s
#         factor: 2
#         maxDuration: 3m
#   ignoreDifferences:
#     - group: admissionregistration.k8s.io
#       kind: ValidatingWebhookConfiguration
#       jqPathExpressions:
#         - .webhooks[].clientConfig.caBundle
#     - group: admissionregistration.k8s.io
#       kind: MutatingWebhookConfiguration
#       jqPathExpressions:
#         - .webhooks[].clientConfig.caBundle

---
# ============================================================================
# external-secrets (sync wave 2 - needed for secrets)
# ============================================================================
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: platform-external-secrets
  namespace: rex5-cc-mz-k8s-argocd
  annotations:
    argocd.argoproj.io/sync-wave: "2"
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: platform
  sources:
    # Helm chart
    - repoURL: https://charts.external-secrets.io
      chart: external-secrets
      targetRevision: 0.17.0  # Updated to support v1 API
      helm:
        valueFiles:
          - $values/platform-mz/external-secrets/values.yaml
    # Values from Git
    - repoURL: git@github.com:kevrex5/kubernetes.git
      targetRevision: HEAD
      ref: values
    # ClusterSecretStores and other resources
    - repoURL: git@github.com:kevrex5/kubernetes.git
      targetRevision: HEAD
      path: platform-mz/external-secrets
      directory:
        exclude: '{values.yaml,kustomization.yaml}'
  destination:
    server: https://kubernetes.default.svc
    namespace: rex5-cc-mz-k8s-external-secrets
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=false
      - ServerSideApply=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
  ignoreDifferences:
    - group: admissionregistration.k8s.io
      kind: ValidatingWebhookConfiguration
      jqPathExpressions:
        - .webhooks[].clientConfig.caBundle
    - group: admissionregistration.k8s.io
      kind: MutatingWebhookConfiguration
      jqPathExpressions:
        - .webhooks[].clientConfig.caBundle

---
# ============================================================================
# Traefik (sync wave 3 - ingress controller)
# ============================================================================
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: platform-traefik
  namespace: rex5-cc-mz-k8s-argocd
  annotations:
    argocd.argoproj.io/sync-wave: "3"
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: platform
  sources:
    # Helm chart
    - repoURL: https://traefik.github.io/charts
      chart: traefik
      targetRevision: 38.0.2  # Pinned version
      helm:
        valueFiles:
          - $values/platform-mz/traefik/values.yaml
    # Values from Git
    - repoURL: git@github.com:kevrex5/kubernetes.git
      targetRevision: HEAD
      ref: values
    # Gateway, ExternalSecret, NetworkPolicies
    - repoURL: git@github.com:kevrex5/kubernetes.git
      targetRevision: HEAD
      path: platform-mz/traefik
      directory:
        exclude: '{values.yaml,kustomization.yaml}'
  destination:
    server: https://kubernetes.default.svc
    namespace: rex5-cc-mz-k8s-traefik
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=false
      - ServerSideApply=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m

# ---
---
# ============================================================================
# Authentik (sync wave 4 - SSO/IdP)
# ============================================================================
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: platform-authentik
  namespace: rex5-cc-mz-k8s-argocd
  annotations:
    argocd.argoproj.io/sync-wave: "4"
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: platform
  sources:
    # Helm chart
    - repoURL: https://charts.goauthentik.io
      chart: authentik
      targetRevision: 2025.12.1  # Pinned version
      helm:
        valueFiles:
          - $values/platform-mz/authentik/values.yaml
    # Values from Git
    - repoURL: git@github.com:kevrex5/kubernetes.git
      targetRevision: HEAD
      ref: values
    # HTTPRoute, ExternalSecret, Blueprints (kustomize)
    - repoURL: git@github.com:kevrex5/kubernetes.git
      targetRevision: HEAD
      path: platform-mz/authentik
  destination:
    server: https://kubernetes.default.svc
    namespace: rex5-cc-mz-k8s-authentik
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=false
      - ServerSideApply=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m

---
# ============================================================================
# Monitoring - kube-prometheus-stack (sync wave 5)
# ============================================================================
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: platform-monitoring
  namespace: rex5-cc-mz-k8s-argocd
  annotations:
    argocd.argoproj.io/sync-wave: "5"
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: platform
  sources:
    # Helm chart
    - repoURL: https://prometheus-community.github.io/helm-charts
      chart: kube-prometheus-stack
      targetRevision: 70.4.1  # Pinned version
      helm:
        valueFiles:
          - $values/platform-mz/monitoring/values.yaml
        skipCrds: false
    # Values from Git
    - repoURL: git@github.com:kevrex5/kubernetes.git
      targetRevision: HEAD
      ref: values
    # HTTPRoutes, ExternalSecrets, NetworkPolicies (kustomize)
    - repoURL: git@github.com:kevrex5/kubernetes.git
      targetRevision: HEAD
      path: platform-mz/monitoring
  destination:
    server: https://kubernetes.default.svc
    namespace: rex5-cc-mz-k8s-monitoring
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=false
      - ServerSideApply=true
      - RespectIgnoreDifferences=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
  ignoreDifferences:
    - group: admissionregistration.k8s.io
      kind: ValidatingWebhookConfiguration
      jqPathExpressions:
        - .webhooks[].clientConfig.caBundle
    - group: admissionregistration.k8s.io
      kind: MutatingWebhookConfiguration
      jqPathExpressions:
        - .webhooks[].clientConfig.caBundle
