# ArgoCD Installation Values
# Apply manually during bootstrap:
#   helm repo add argo https://argoproj.github.io/argo-helm
#   helm install argocd argo/argo-cd -n argocd --create-namespace -f values.yaml

# Global settings
global:
  domain: argocd.rex5.ca

  # Tolerate spot nodes (required for AKS spot node pools)
  tolerations:
    - key: "kubernetes.azure.com/scalesetpriority"
      operator: "Equal"
      value: "spot"
      effect: "NoSchedule"

  # Prefer spot nodes for cost optimization
  affinity:
    nodeAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 1
          preference:
            matchExpressions:
              - key: "kubernetes.azure.com/scalesetpriority"
                operator: In
                values:
                  - "spot"

# Server configuration
server:
  replicas: 2

  # Extra args for insecure mode (TLS terminated at ingress)
  extraArgs:
    - --insecure

  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

# Repo server
repoServer:
  replicas: 2
  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi
  
  # Workload Identity for CZ cluster access
  serviceAccount:
    annotations:
      azure.workload.identity/client-id: "63de6227-6397-4376-bb12-741e739440f0"
      azure.workload.identity/tenant-id: "14021cba-cdc0-4c87-a145-b66f94b7017f"
    labels:
      azure.workload.identity/use: "true"
  
  # Add kubelogin for Azure AD Workload Identity authentication
  volumes:
    - name: kubelogin
      emptyDir: {}
  volumeMounts:
    - name: kubelogin
      mountPath: /usr/local/bin/kubelogin
      subPath: kubelogin
  initContainers:
    - name: download-kubelogin
      image: mcr.microsoft.com/azure-cli:latest
      command:
        - sh
        - -c
        - |
          az aks install-cli --only-show-errors --kubelogin-install-location /kubelogin/kubelogin
      volumeMounts:
        - name: kubelogin
          mountPath: /kubelogin

# Application controller
controller:
  replicas: 1
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 1000m
      memory: 1Gi
  
  # -------------------------------------------------------------------------
  # Workload Identity for CZ Cluster Management
  # -------------------------------------------------------------------------
  # This annotation enables the MZ ArgoCD controller to authenticate to the
  # CZ cluster using Azure AD Workload Identity.
  #
  # The federated credential on rex5-cc-cz-prod-argocd-identity trusts:
  #   Subject: system:serviceaccount:rex5-cc-mz-k8s-argocd:argocd-application-controller
  #
  # See: argocd/deployments/cz/cz-cluster-secret.yaml for cluster registration
  # -------------------------------------------------------------------------
  serviceAccount:
    annotations:
      azure.workload.identity/client-id: "63de6227-6397-4376-bb12-741e739440f0"
      azure.workload.identity/tenant-id: "14021cba-cdc0-4c87-a145-b66f94b7017f"
    labels:
      azure.workload.identity/use: "true"
  
  # Add kubelogin for Azure AD Workload Identity authentication
  volumes:
    - name: kubelogin
      emptyDir: {}
  volumeMounts:
    - name: kubelogin
      mountPath: /usr/local/bin/kubelogin
      subPath: kubelogin
  initContainers:
    - name: download-kubelogin
      image: mcr.microsoft.com/azure-cli:latest
      command:
        - sh
        - -c
        - |
          az aks install-cli --only-show-errors --kubelogin-install-location /kubelogin/kubelogin
      volumeMounts:
        - name: kubelogin
          mountPath: /kubelogin

# Redis
redis:
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 256Mi

# Disable built-in ingress (we use Gateway API)
server:
  ingress:
    enabled: false

# Config settings
configs:
  params:
    # Server settings
    server.insecure: true  # TLS at Gateway level

  cm:
    # URL for ArgoCD
    url: https://argocd.rex5.ca

    # Enable status badge
    statusbadge.enabled: true

    # Resource customizations (ignore webhook CA bundles)
    resource.customizations.ignoreDifferences.admissionregistration.k8s.io_ValidatingWebhookConfiguration: |
      jqPathExpressions:
        - .webhooks[].clientConfig.caBundle
    resource.customizations.ignoreDifferences.admissionregistration.k8s.io_MutatingWebhookConfiguration: |
      jqPathExpressions:
        - .webhooks[].clientConfig.caBundle

  # RBAC settings
  rbac:
    policy.default: role:readonly
    policy.csv: |
      g, argocd-admins, role:admin
