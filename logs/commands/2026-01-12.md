# Commands ‚Äî 2026-01-12

## Context
- Goal: Continue cluster development - add monitoring stack, fix platform structure
- Branch/PR: main (development)
- Cluster/Namespace: N/A (pre-deployment configuration)

## Changes Made

### 1. Created Monitoring Stack (kube-prometheus-stack)
- `platform/monitoring/values.yaml` - Full Prometheus, Grafana, Alertmanager configuration
- `platform/monitoring/httproutes.yaml` - Gateway API routes for Grafana, Prometheus, Alertmanager
- `platform/monitoring/externalsecrets.yaml` - ExternalSecrets for Grafana admin password and OAuth
- `platform/monitoring/networkpolicies.yaml` - Network policies for monitoring namespace
- `platform/monitoring/kustomization.yaml` - Kustomization file for monitoring resources

### 2. Created Platform Kustomization Files
- `platform/namespaces/kustomization.yaml` - Includes all namespace manifests
- `platform/traefik/kustomization.yaml` - Gateway, ExternalSecret, NetworkPolicies
- `platform/traefik/networkpolicies.yaml` - Network policies for Traefik ingress
- `platform/cert-manager/kustomization.yaml` - ClusterIssuers
- `platform/external-secrets/kustomization.yaml` - ClusterSecretStores
- `platform/authentik/kustomization.yaml` - HTTPRoute, ExternalSecret
- `argocd/install/kustomization.yaml` - HTTPRoute for ArgoCD

### 3. Created Missing Namespace Manifest
- `platform/namespaces/argocd.yaml` - ArgoCD namespace with baseline PSA and route-allowed label

### 4. Fixed Namespace Labels
- Updated `platform/namespaces/authentik.yaml` - Added `gateway.networking.k8s.io/route-allowed: "true"`
- Updated `platform/namespaces/monitoring.yaml` - Added `gateway.networking.k8s.io/route-allowed: "true"`

### 5. Refactored Platform ArgoCD Apps
- Replaced ApplicationSet with individual Applications
- Implemented multi-source Applications for Helm charts:
  - Helm chart from chart repository
  - Values file from Git repository
  - Additional resources (CRDs, routes) from Git repository
- Updated to latest stable chart versions:
  - cert-manager: v1.17.1
  - external-secrets: 0.14.3
  - traefik: 35.0.0
  - authentik: 2025.1.0
  - kube-prometheus-stack: 70.4.1

## ‚úÖ Worked
- File creation for all monitoring stack components
- Kustomization structure for all platform components
- Multi-source Application pattern for Helm + Git resources

## ‚ùå Failed
- N/A (configuration only, no cluster operations)

## üö´ DO NOT RETRY
- N/A

## Next Steps
1. Replace `<ORG>/<REPO>` placeholders with actual Git repository URL
2. Replace `<DOMAIN>` placeholders with actual domain (e.g., rex5.ca)
3. Replace Azure resource placeholders in:
   - `platform/traefik/values.yaml` - Public IP configuration
   - `platform/cert-manager/values.yaml` - Managed Identity Client ID
   - `platform/cert-manager/clusterissuers.yaml` - Azure DNS configuration
   - `platform/external-secrets/values.yaml` - Managed Identity Client ID
   - `platform/external-secrets/clustersecretstores.yaml` - Key Vault URL
4. Create required secrets in Azure Key Vault:
   - `grafana-admin-password`
   - `grafana-oauth-client-id`
   - `grafana-oauth-client-secret`
   - `authentik-secret-key`
   - `authentik-postgres-password`
5. Configure Authentik applications/providers for:
   - Grafana OIDC
   - PDFDing OIDC
6. Bootstrap cluster following AGENTS.md workflow
