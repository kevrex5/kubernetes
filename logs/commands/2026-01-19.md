# Commands ‚Äî 2026-01-19

## Context
- Goal: Troubleshoot ArgoCD sync issues - apps not auto-syncing, cert-manager failing
- Branch/PR: main
- Cluster/Namespace: AKS cluster, rex5-cc-mz-k8s-* namespaces

## Findings

### 1. ArgoCD is Running
All ArgoCD pods are healthy and running:
- argocd-application-controller
- argocd-applicationset-controller  
- argocd-dex-server
- argocd-notifications-controller
- argocd-redis
- argocd-repo-server (2 replicas)
- argocd-server

### 2. Application Sync Status Issues
Multiple applications showing as OutOfSync despite automated sync being enabled:
- root: OutOfSync (but Healthy)
- platform-cert-manager: OutOfSync (Healthy)
- platform-external-secrets: OutOfSync (Progressing)
- platform-monitoring: OutOfSync (Missing)
- platform-shared: OutOfSync (Degraded)
- platform-traefik: Unknown sync status (Healthy)
- platform-authentik: Unknown sync status (Healthy)

Only platform-namespaces is fully Synced and Healthy.

### 3. Root Cause #1: Azure Workload Identity NOT Configured
**CRITICAL**: cert-manager cannot issue certificates due to Azure auth failure:

```
AADSTS700213: No matching federated identity record found for presented assertion 
subject 'system:serviceaccount:rex5-cc-mz-k8s-cert-manager:cert-manager'
```

This means:
- The Azure Managed Identity exists (client ID: 08d54073-58ed-434a-b351-8c87a17a775a)
- The Kubernetes service account is properly annotated
- **BUT** the federated identity credential is NOT configured in Azure

The wildcard certificate cannot be issued until this is fixed.

### 4. ArgoCD Sync Behavior
- Automated sync is enabled on all applications (prune: true, selfHeal: true)
- Applications have proper sync waves configured (-1 to 5)
- Manual sync triggers via kubectl patch work
- Some apps show "Unknown" sync status (platform-traefik, platform-authentik)
- This suggests ArgoCD may need a hard refresh or there's an issue with status reconciliation

## ‚úÖ Worked

```bash
# Check ArgoCD pods status
kubectl -n rex5-cc-mz-k8s-argocd get pods

# List all applications
kubectl get application -n rex5-cc-mz-k8s-argocd

# Check application details
kubectl -n rex5-cc-mz-k8s-argocd describe application root

# Verify automated sync policy
kubectl -n rex5-cc-mz-k8s-argocd get application root -o jsonpath='{.spec.syncPolicy.automated}' | jq '.'

# Check cert-manager logs for errors
kubectl -n rex5-cc-mz-k8s-cert-manager logs deployment/platform-cert-manager --tail=50 | grep -i "error\|failed"

# Check certificate status
kubectl -n rex5-cc-mz-k8s-shared describe certificate wildcard-cert

# Manually trigger sync (temporary workaround)
kubectl -n rex5-cc-mz-k8s-argocd patch application root -p '{"operation":{"initiatedBy":{"username":"admin"},"sync":{"syncStrategy":{"apply":{}}}}}' --type merge

# Force refresh of application
kubectl -n rex5-cc-mz-k8s-argocd annotate application root argocd.argoproj.io/refresh=normal --overwrite
```

## ‚ùå Failed

```bash
# ArgoCD CLI commands don't work (argocd CLI not installed locally)
argocd app get platform-cert-manager
argocd app sync root --dry-run
```

## üö´ DO NOT RETRY

N/A - All commands were useful for diagnosis

## Required Actions

### CRITICAL: Fix Azure Workload Identity for cert-manager

The managed identity needs a federated identity credential configured in Azure:

1. Go to Azure Portal ‚Üí Managed Identities ‚Üí find identity with client ID `08d54073-58ed-434a-b351-8c87a17a775a`
2. Add Federated Credential with:
   - **Name**: `cert-manager-federated-identity`
   - **Scenario**: Kubernetes accessing Azure resources
   - **Cluster Issuer URL**: Get from AKS cluster (run: `az aks show -g <RG> -n <AKS> --query "oidcIssuerProfile.issuerUrl" -o tsv`)
   - **Namespace**: `rex5-cc-mz-k8s-cert-manager`
   - **Service Account**: `cert-manager`
   - **Subject**: `system:serviceaccount:rex5-cc-mz-k8s-cert-manager:cert-manager`

### ArgoCD Sync Investigation

Need to determine why automated sync isn't triggering:
1. Check ArgoCD application controller logs more thoroughly
2. Verify sync windows aren't blocking syncs
3. Check if there are resource finalizers preventing syncs
4. Review if diff detection is working properly for multi-source apps

### Alternative: Install ArgoCD CLI

To get better diagnostics:
```bash
# On Linux
curl -sSL -o argocd-linux-amd64 https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
sudo install -m 555 argocd-linux-amd64 /usr/local/bin/argocd
rm argocd-linux-amd64

# Login to ArgoCD
kubectl -n rex5-cc-mz-k8s-argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
argocd login <argocd-server-url> --username admin --password <password>
```

## Next Steps

1. **FIRST**: Fix Azure Workload Identity federated credential (blocks certificate issuance)
2. Install ArgoCD CLI for better debugging
3. Investigate why automated sync isn't triggering
4. Once cert-manager auth is fixed, wildcard certificate should issue successfully
5. Once wildcard cert exists, platform-shared should become Healthy
6. Address any remaining OutOfSync applications

## Notes

- The cluster infrastructure is mostly healthy
- Main issue is Azure identity configuration (external to Kubernetes)
- ArgoCD sync behavior may just need patience (refresh cycle) or may indicate a configuration issue
- All application definitions look correct (multi-source pattern properly configured)

---

## RESOLUTION (2026-01-20 04:56 UTC)

### ‚úÖ Issue Fixed: Azure Workload Identity Namespace Mismatch

**Root Cause Confirmed:**
The federated identity credentials in Azure were configured with the **wrong namespace**:
- ‚ùå Old: `system:serviceaccount:cert-manager:cert-manager`
- ‚úÖ Fixed: `system:serviceaccount:rex5-cc-mz-k8s-cert-manager:cert-manager`

**Actions Taken:**
1. Updated Terraform file: `/home/krichar/terraform/rex5/mz/canadacentral/network/rex5.ca/cert-manager-identity.tf`
   - Changed line 27 subject to use `rex5-cc-mz-k8s-cert-manager` namespace
2. Imported existing Azure resources into Terraform state:
   - Resource group: `rex5-cc-mz-prod-dns-rg`
   - Managed identity: `cert-manager-dns01`
   - Federated identity credential
3. Applied Terraform changes: `terragrunt apply`
4. Restarted cert-manager deployment: `kubectl -n rex5-cc-mz-k8s-cert-manager rollout restart deployment platform-cert-manager`

**Result:**
```bash
‚úÖ Wildcard certificate ISSUED successfully!
   Subject: CN = *.rex5.ca
   Valid: Jan 20 03:58:26 2026 GMT ‚Üí Apr 20 03:58:25 2026 GMT
   Status: Ready (Certificate is up to date and has not expired)
```

**Verification:**
```bash
kubectl -n rex5-cc-mz-k8s-shared get certificate wildcard-cert
# NAME            READY   SECRET         AGE
# wildcard-cert   True    wildcard-tls   3h11m
```

### Remaining Work

**External-secrets federated identity** also needs the same fix:
- File: `/home/krichar/terraform/rex5/mz/canadacentral/compute/aks-cluster/avm-res-authorization-federated-identity-external-secrets.tf`
- Uncomment resource block and change subject from:
  - `system:serviceaccount:external-secrets:external-secrets`
  - To: `system:serviceaccount:rex5-cc-mz-k8s-external-secrets:external-secrets`

**ArgoCD Auto-Sync Investigation:**
- Applications still showing OutOfSync despite automated sync enabled
- Manual sync triggers work fine
- May need to review ArgoCD application controller logs or sync policies
