# Commands ‚Äî 2026-01-21

## Context
- Goal: Migrate platform resources to ArgoCD GitOps management with proper namespace naming (`rex5-cc-mz-k8s-*`)
- Branch: master
- Cluster: rex5-cc-mz-prod-aks (Canada Central)

## ‚úÖ Worked

### Platform-Shared Resource Migration
```bash
# Moved wildcard certificate from cert-manager to traefik namespace (TLS termination point)
kubectl delete certificate wildcard-cert -n rex5-cc-mz-k8s-cert-manager
kubectl delete pushsecret push-wildcard-cert -n rex5-cc-mz-k8s-cert-manager

# Copied valid wildcard cert from old namespace
kubectl get secret wildcard-rex5-ca-tls -n shared -o yaml | \
  sed 's/namespace: shared/namespace: rex5-cc-mz-k8s-traefik/' | \
  sed 's/name: wildcard-rex5-ca-tls/name: wildcard-tls/' | \
  kubectl apply -f -
```
- Expected: Certificate secret available for Traefik
- Result: ‚úÖ Secret created, Traefik can use it for TLS termination

### Traefik Migration
```bash
# Scale down old traefik
kubectl scale deployment traefik -n traefik --replicas=0

# Delete old service to free LoadBalancer IP
kubectl delete svc traefik -n traefik

# Clean up conflicting TLS Store
kubectl delete tlsstore default -n traefik

# Sync new Traefik deployment
kubectl patch app platform-traefik -n rex5-cc-mz-k8s-argocd --type merge -p '{"operation":{"sync":{"revision":"HEAD"}}}'
```
- Expected: Traefik running in rex5-cc-mz-k8s-traefik with IP 4.204.154.192
- Result: ‚úÖ 3 pods running, LoadBalancer assigned, Gateway Programmed=True

### Git Operations
```bash
# Remove platform-shared directory (migrated resources)
rm -rf platform/shared

# Move Traefik values to standard location
mv platform/traefik/install/values.yaml platform/traefik/values.yaml
rm -rf platform/traefik/install

# Remove duplicate ExternalSecret
rm platform/traefik/externalsecret-wildcard.yaml

# Remove custom Gateway definition (let Helm manage it)
rm platform/traefik/gateway.yaml
```
- Expected: Clean directory structure, GitOps-compliant
- Result: ‚úÖ All committed and pushed successfully

## ‚ùå Failed

### Let's Encrypt Certificate Issuance
```bash
kubectl describe certificate wildcard-cert -n rex5-cc-mz-k8s-traefik
```
- Error: Rate limit hit - "too many certificates (5) already issued for this exact set of identifiers in the last 168h0m0s"
- Why: Multiple failed attempts during migration testing
- Workaround: ‚úÖ Copied working certificate from old namespace (valid until 2026-04-03)
- Fix: Wait until 2026-01-23 for rate limit reset, use letsencrypt-staging for testing

### ArgoCD AppProject Missing IngressClass Permission
```bash
kubectl patch app platform-traefik -n rex5-cc-mz-k8s-argocd --type merge -p '{"operation":{"sync":{"revision":"HEAD"}}}'
```
- Error: "resource networking.k8s.io:IngressClass is not permitted in project platform"
- Why: Traefik chart creates IngressClass by default, not whitelisted in AppProject
- Fix: ‚úÖ Added IngressClass to platform project clusterResourceWhitelist, then disabled in values (not needed for Gateway API)

### Authentik Chart Version Not Found
```bash
# Attempted sync with old chart version
```
- Error: Chart "authentik" version "2025.1.0" not found
- Why: Chart version doesn't exist in repo
- Fix: ‚úÖ Updated to 2025.12.1 (latest available)

## üö´ DO NOT RETRY

### Direct kubectl edits of ArgoCD-managed resources
- Reason: ArgoCD will revert any manual changes
- What to do instead: Update Git, commit, push, sync via ArgoCD

### Creating multiple wildcard certificates
- Reason: Let's Encrypt rate limit (5/week)
- What to do instead: Use letsencrypt-staging for testing, copy existing valid cert for prod

### Using old gateway references in HTTPRoutes
- Reason: Old `shared-gw` gateway being deprecated
- What to do instead: Reference `traefik-gateway` in `rex5-cc-mz-k8s-traefik` namespace

## Key Decisions Made

1. **Wildcard certificate location**: Moved to `rex5-cc-mz-k8s-traefik` namespace (TLS termination point)
2. **Gateway management**: Let Helm chart manage Gateway/GatewayClass instead of custom definitions
3. **IngressClass**: Disabled (using Gateway API exclusively, no legacy Ingress support)
4. **Traefik chart version**: Upgraded to 38.0.2 (image v3.6.6)
5. **Namespace naming**: All platform resources use `rex5-cc-mz-k8s-*` prefix

## Current State

### Working
- ‚úÖ Traefik deployed to rex5-cc-mz-k8s-traefik (3 pods, LoadBalancer 4.204.154.192)
- ‚úÖ Gateway API configured (traefik-gateway, Programmed=True)
- ‚úÖ Wildcard certificate available (valid until 2026-04-03)
- ‚úÖ PushSecret syncing certificate to Key Vault
- ‚úÖ HTTPRoutes updated to reference new gateway

### In Progress
- ‚è≥ Authentik migration (chart version updated, awaiting sync)
- ‚è≥ Monitoring migration (needs configuration check)

### Cleanup Needed
- Old `shared-gw` Gateway in `traefik` namespace (waiting for app migrations)
- Old deployments in `authentik`, `monitoring` namespaces
- Old `traefik` namespace (after all apps migrated)

## Next Steps

1. Complete authentik and monitoring app migrations
2. Update HTTPRoutes in old namespaces to point to services in new namespaces
3. Verify apps working in new namespaces
4. Delete old gateways and namespaces
5. Document final state in ADR
