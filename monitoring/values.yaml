# kube-prometheus-stack Helm Values
# Chart: https://prometheus-community.github.io/helm-charts
# Version: Pin in ArgoCD ApplicationSet
#
# Includes: Prometheus, Grafana, Alertmanager, Node Exporter, kube-state-metrics

# Grafana configuration
grafana:
  enabled: true
  adminUser: admin
  # Password set via secret
  adminPassword: ""
  existingSecret: grafana-admin-secret
  
  # Persistence
  persistence:
    enabled: true
    size: 10Gi
    storageClassName: managed-csi  # Azure Disk CSI
  
  # Resources
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  
  # Pod security
  securityContext:
    runAsNonRoot: true
    runAsUser: 472
    fsGroup: 472
    seccompProfile:
      type: RuntimeDefault
  
  containerSecurityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: false
    runAsNonRoot: true
    runAsUser: 472
  
  # Disable built-in ingress (use Gateway API)
  ingress:
    enabled: false
  
  # Datasources (auto-configure Prometheus)
  sidecar:
    datasources:
      enabled: true
    dashboards:
      enabled: true
      searchNamespace: ALL
  
  # Default dashboards
  defaultDashboardsEnabled: true
  
  # Grafana.ini settings
  grafana.ini:
    server:
      root_url: https://grafana.rex5.ca
    auth:
      disable_login_form: false
    auth.anonymous:
      enabled: false
    # OIDC via Authentik
    auth.generic_oauth:
      enabled: true
      name: Authentik
      allow_sign_up: true
      client_id: $__env{GRAFANA_OAUTH_CLIENT_ID}
      client_secret: $__env{GRAFANA_OAUTH_CLIENT_SECRET}
      scopes: openid profile email groups
      auth_url: https://auth.rex5.ca/application/o/authorize/
      token_url: https://auth.rex5.ca/application/o/token/
      api_url: https://auth.rex5.ca/application/o/userinfo/
      role_attribute_path: "contains(groups[*], 'grafana-admin') && 'Admin' || contains(groups[*], 'grafana-editor') && 'Editor' || 'Viewer'"

  # Environment from secret (OIDC credentials)
  envFromSecret: grafana-oauth-secret

# Prometheus configuration
prometheus:
  enabled: true
  
  prometheusSpec:
    # Retention
    retention: 15d
    retentionSize: 45GB
    
    # Storage
    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: managed-csi
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 50Gi
    
    # Resources
    resources:
      requests:
        cpu: 200m
        memory: 1Gi
      limits:
        cpu: 1000m
        memory: 2Gi
    
    # Service monitor selector (discover all)
    serviceMonitorSelectorNilUsesHelmValues: false
    podMonitorSelectorNilUsesHelmValues: false
    probeSelectorNilUsesHelmValues: false
    scrapeConfigSelectorNilUsesHelmValues: false
    
    # Pod security
    securityContext:
      runAsNonRoot: true
      runAsUser: 1000
      fsGroup: 2000
      seccompProfile:
        type: RuntimeDefault
    
    # Tolerations
    tolerations:
      - key: CriticalAddonsOnly
        operator: Equal
        value: "true"
        effect: NoSchedule

# Alertmanager configuration
alertmanager:
  enabled: true
  
  alertmanagerSpec:
    # Resources
    resources:
      requests:
        cpu: 10m
        memory: 64Mi
      limits:
        cpu: 100m
        memory: 128Mi
    
    # Storage
    storage:
      volumeClaimTemplate:
        spec:
          storageClassName: managed-csi
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 1Gi
    
    # Pod security
    securityContext:
      runAsNonRoot: true
      runAsUser: 1000
      fsGroup: 2000
      seccompProfile:
        type: RuntimeDefault
    
    # Tolerations
    tolerations:
      - key: CriticalAddonsOnly
        operator: Equal
        value: "true"
        effect: NoSchedule

  # Alertmanager config
  config:
    global:
      resolve_timeout: 5m
    route:
      group_by: ['alertname', 'namespace']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 12h
      receiver: 'null'
      routes:
        # Critical alerts
        - match:
            severity: critical
          receiver: 'critical-alerts'
          continue: true
        # Warning alerts
        - match:
            severity: warning
          receiver: 'warning-alerts'
    receivers:
      - name: 'null'
      - name: 'critical-alerts'
        # TODO: Configure Slack/PagerDuty webhook
        # slack_configs:
        #   - api_url: '<SLACK_WEBHOOK_URL>'
        #     channel: '#alerts-critical'
      - name: 'warning-alerts'
        # TODO: Configure notification channel

# Node exporter (DaemonSet on all nodes)
nodeExporter:
  enabled: true
  resources:
    requests:
      cpu: 10m
      memory: 32Mi
    limits:
      cpu: 100m
      memory: 64Mi

# kube-state-metrics
kubeStateMetrics:
  enabled: true
  resources:
    requests:
      cpu: 10m
      memory: 64Mi
    limits:
      cpu: 100m
      memory: 128Mi

# Prometheus Operator
prometheusOperator:
  enabled: true
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  tolerations:
    - key: CriticalAddonsOnly
      operator: Equal
      value: "true"
      effect: NoSchedule

# Default scraping rules
defaultRules:
  create: true
  rules:
    alertmanager: true
    etcd: false  # Not accessible on AKS managed control plane
    configReloaders: true
    general: true
    k8s: true
    kubeApiserverAvailability: true
    kubeApiserverBurnrate: true
    kubeApiserverHistogram: true
    kubeApiserverSlos: true
    kubeControllerManager: false  # Not accessible on AKS
    kubelet: true
    kubeProxy: false  # Not accessible on AKS
    kubePrometheusGeneral: true
    kubePrometheusNodeRecording: true
    kubernetesApps: true
    kubernetesResources: true
    kubernetesStorage: true
    kubernetesSystem: true
    kubeSchedulerAlerting: false  # Not accessible on AKS
    kubeSchedulerRecording: false  # Not accessible on AKS
    kubeStateMetrics: true
    network: true
    node: true
    nodeExporterAlerting: true
    nodeExporterRecording: true
    prometheus: true
    prometheusOperator: true
