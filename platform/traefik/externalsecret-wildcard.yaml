---
# ExternalSecret - pulls wildcard TLS certificate from Key Vault for Gateway
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: wildcard-tls
  namespace: rex5-cc-mz-k8s-traefik
spec:
  secretStoreRef:
    name: azure-keyvault-store
    kind: ClusterSecretStore
  target:
    name: wildcard-tls
    creationPolicy: Owner
    template:
      type: kubernetes.io/tls
      data:
        tls.crt: "{{ .cert | b64dec }}"
        tls.key: "{{ .key | b64dec }}"
  dataFrom:
    - extract:
        key: wildcard-tls-cert
      rewrite:
        - regexp:
            source: "(.*)"
            target: "cert"
    - extract:
        key: wildcard-tls-key
      rewrite:
        - regexp:
            source: "(.*)"
            target: "key"
